<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Conex√£o - Sistema de Apontamento</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste de Conex√£o - Sistema de Apontamento</h1>
        
        <div id="status" class="status info">
            Clique em "Testar Conex√£o" para verificar se o sistema est√° funcionando.
        </div>

        <div>
            <button onclick="testConnection()">üîó Testar Conex√£o</button>
            <button onclick="testLogin()">üë§ Testar Login</button>
            <button onclick="loadBatches()">üì¶ Carregar Lotes</button>
            <button onclick="loadUsers()">üë• Carregar Usu√°rios</button>
        </div>

        <div id="results"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';

        const SUPABASE_URL = "https://zxicuufhyuzhrsolwckm.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4aWN1dWZoeXV6aHJzb2x3Y2ttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDQ3MTQsImV4cCI6MjA3MDU4MDcxNH0.67ND9IeqhAm2eA4hPfEj71DzJjoGwaZVyQJNonhhjOU";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        window.supabase = supabase;

        window.testConnection = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Testando conex√£o...';
            resultsDiv.innerHTML = '';

            try {
                // Teste b√°sico de conex√£o
                const { data, error } = await supabase
                    .from('batches')
                    .select('count')
                    .limit(1);

                if (error) throw error;

                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Conex√£o com Supabase estabelecida com sucesso!';
                
                resultsDiv.innerHTML = `
                    <h3>‚úÖ Teste de Conex√£o Bem-sucedido</h3>
                    <p>O sistema conseguiu se conectar ao banco de dados Supabase.</p>
                `;
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Erro na conex√£o: ' + error.message;
                
                resultsDiv.innerHTML = `
                    <h3>‚ùå Erro de Conex√£o</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                    <p><strong>Detalhes:</strong> ${JSON.stringify(error, null, 2)}</p>
                `;
            }
        };

        window.testLogin = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Testando login de operador...';

            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', 'operador1@empresa.com')
                    .eq('active', true)
                    .eq('role', 'operator');

                if (error) throw error;

                if (users && users.length > 0) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Login de operador funcionando!';
                    
                    resultsDiv.innerHTML = `
                        <h3>‚úÖ Teste de Login Bem-sucedido</h3>
                        <p><strong>Usu√°rio encontrado:</strong> ${users[0].name}</p>
                        <p><strong>Email:</strong> ${users[0].email}</p>
                        <p><strong>Role:</strong> ${users[0].role}</p>
                        <p><strong>Ativo:</strong> ${users[0].active ? 'Sim' : 'N√£o'}</p>
                    `;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Usu√°rio operador1@empresa.com n√£o encontrado';
                    
                    resultsDiv.innerHTML = `
                        <h3>‚ùå Usu√°rio N√£o Encontrado</h3>
                        <p>O usu√°rio operador1@empresa.com n√£o foi encontrado no banco de dados.</p>
                    `;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Erro no teste de login: ' + error.message;
                
                resultsDiv.innerHTML = `
                    <h3>‚ùå Erro no Teste de Login</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                `;
            }
        };

        window.loadBatches = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Carregando lotes...';

            try {
                const { data: batches, error } = await supabase
                    .from('batches')
                    .select('*')
                    .eq('status', 'Em andamento')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                statusDiv.className = 'status success';
                statusDiv.textContent = `‚úÖ ${batches.length} lote(s) carregado(s)`;
                
                let tableHTML = `
                    <h3>üì¶ Lotes Ativos</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>Data In√≠cio</th>
                                <th>Data Fim</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                batches.forEach(batch => {
                    tableHTML += `
                        <tr>
                            <td>${batch.code}</td>
                            <td>${batch.name}</td>
                            <td>${batch.status}</td>
                            <td>${batch.start_date}</td>
                            <td>${batch.end_date}</td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                resultsDiv.innerHTML = tableHTML;

                // Carregar pe√ßas para cada lote
                for (const batch of batches) {
                    const { data: pieces, error: piecesError } = await supabase
                        .from('pieces')
                        .select('*')
                        .eq('batch_id', batch.id);

                    if (!piecesError && pieces.length > 0) {
                        let piecesHTML = `
                            <h4>üîß Pe√ßas do Lote ${batch.name}</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Planejado</th>
                                        <th>Produzido</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        pieces.forEach(piece => {
                            const completed = piece.produced_quantity >= piece.quantity;
                            piecesHTML += `
                                <tr>
                                    <td>${piece.code}</td>
                                    <td>${piece.description}</td>
                                    <td>${piece.quantity}</td>
                                    <td>${piece.produced_quantity}</td>
                                    <td>${completed ? '‚úÖ Completo' : '‚è≥ Em andamento'}</td>
                                </tr>
                            `;
                        });

                        piecesHTML += '</tbody></table>';
                        resultsDiv.innerHTML += piecesHTML;
                    }
                }

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Erro ao carregar lotes: ' + error.message;
                
                resultsDiv.innerHTML = `
                    <h3>‚ùå Erro ao Carregar Lotes</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                `;
            }
        };

        window.loadUsers = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Carregando usu√°rios...';

            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, name, email, role, active, last_login')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                statusDiv.className = 'status success';
                statusDiv.textContent = `‚úÖ ${users.length} usu√°rio(s) carregado(s)`;
                
                let tableHTML = `
                    <h3>üë• Usu√°rios do Sistema</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Ativo</th>
                                <th>√öltimo Login</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                users.forEach(user => {
                    tableHTML += `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${user.role}</td>
                            <td>${user.active ? '‚úÖ Sim' : '‚ùå N√£o'}</td>
                            <td>${user.last_login ? new Date(user.last_login).toLocaleString('pt-BR') : 'Nunca'}</td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                resultsDiv.innerHTML = tableHTML;

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Erro ao carregar usu√°rios: ' + error.message;
                
                resultsDiv.innerHTML = `
                    <h3>‚ùå Erro ao Carregar Usu√°rios</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                `;
            }
        };
    </script>
</body>
</html>